# Implementation Plan: ChatKit UI Enhancement & Backend Setup

**Branch**: `004-chatkit-backend-integration` | **Date**: 2025-12-13 | **Spec**: [specs/004-chatkit-backend-integration/spec.md](specs/004-chatkit-backend-integration/spec.md)
**Input**: Feature specification from `/specs/004-chatkit-backend-integration/spec.md`

## Summary

This feature aims to develop a modern, interactive chat UI integrated with a FastAPI backend that communicates with the Gemini API for real-time conversational responses. The frontend will utilize enhanced ChatKit UI components for a visually appealing and smooth user experience, including gradient backgrounds, shadows, animations, error boundaries, and loading spinners. The backend will implement a FastAPI application with a `/chat` endpoint to proxy messages to the Gemini API, handle Cross-Origin Resource Sharing (CORS), and manage the `GEMINI_API_KEY` securely via an `.env` file.

## Technical Context

**Language/Version**: Python 3.10+ (for backend), TypeScript (for frontend)
**Primary Dependencies**:
  - Frontend: Next.js, React, ChatKit UI components.
  - Backend: FastAPI, Uvicorn, Google Generative AI (Gemini API client), python-dotenv, uv (package manager).
**Storage**: N/A (this feature is stateless; overall project uses Neon Serverless PostgreSQL)
**Testing**: `pytest` (for backend), `react-testing-library`/`jest` (for frontend)
**Target Platform**: Web (browser-based frontend, server-side Python backend).
**Project Type**: Web application (frontend + backend)
**Performance Goals**:
  - SC-003: Users can successfully send messages through the frontend and receive responses from the Gemini API via the backend `/chat` endpoint within 3 seconds 95% of the time.
  - SC-004: The backend `/chat` endpoint successfully communicates with the Gemini API and returns valid responses without errors for 99.9% of requests.
**Constraints**:
  - CORS enabled for `http://localhost:3000`.
  - `GEMINI_API_KEY` must be loaded from an `.env` file.
**Scale/Scope**: Focus on the chat UI and a single `/chat` endpoint for Gemini API integration.

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

- **Stateless Architecture**: ✅ The backend `/chat` endpoint, as designed, will be stateless, forwarding requests to the Gemini API, aligning with this principle.
- **MCP Tool-Based Design**: ✅ This feature enables the chat interface for the MCP tools, but does not itself implement new MCP tools. It's a foundational piece for tool interaction, aligning with the principle.
- **Single Endpoint Pattern**: ✅ The feature introduces a `/chat` endpoint, which aligns with the single endpoint pattern described in the constitution, potentially being an internal endpoint that eventually connects to the `/api/{user_id}/chat` endpoint from the constitution.
- **Conversation Persistence**: ✅ While this feature's `/chat` endpoint doesn't explicitly implement full conversation persistence, it's designed to be a stateless intermediary for the Gemini API. Integration with the constitution's mandated database persistence (all messages stored in database) would be handled at a higher level, potentially involving another service or the existing `/api/{user_id}/chat` endpoint.
- **Core Technology Stack**:
  - Frontend: OpenAI ChatKit, Next.js, React. Constitution mentions OpenAI ChatKit. ✅ Aligns.
  - Backend: Python FastAPI. Constitution mentions Python FastAPI. ✅ Aligns.
  - AI Framework: ✅ Gemini API (Decision: User requested Gemini API; prioritized over constitution's OpenAI Agents SDK for this feature)
  - Other: MCP Server, SQLModel, Neon Serverless PostgreSQL, Better Auth are not directly used or impacted by this feature's scope. ✅ No conflict.

## Project Structure

### Documentation (this feature)

```text
specs/004-chatkit-backend-integration/
├── plan.md              # This file (/sp.plan command output)
├── research.md          # Phase 0 output (/sp.plan command)
├── data-model.md        # Phase 1 output (/sp.plan command)
├── quickstart.md        # Phase 1 output (/sp.plan command)
├── contracts/           # Phase 1 output (/sp.plan command)
└── tasks.md             # Phase 2 output (/sp.tasks command - NOT created by /sp.plan)
```

### Source Code (repository root)

```text
backend/
├── src/
│   └── main.py       # FastAPI app with /chat endpoint
└── .env              # Store GEMINI_API_KEY
└── uv.lock           # (Generated by uv init/add)

frontend/
├── components/
│   └── chatkit-ui/
│       └── ChatkitWrapper.tsx # UI Enhancement
└── app/
    └── api/
        └── chat/
            └── route.ts # Frontend API route to call backend /chat
└── ... # existing Next.js structure
```

**Structure Decision**: This feature will primarily reside within the `backend/` and `frontend/` directories, aligning with the "Web application (frontend + backend)" option. `main.py` for the FastAPI backend, `.env` for API key, and `ChatkitWrapper.tsx` for UI enhancement. A frontend API route will be added to `frontend/app/api/chat/route.ts` to proxy requests to the backend.

## Complexity Tracking

> **Fill ONLY if Constitution Check has violations that must be justified**

| Violation | Why Needed | Simpler Alternative Rejected Because |
|-----------|------------|-------------------------------------|
| AI Framework (Gemini vs OpenAI) | User explicitly requested Gemini API for this feature, and it provides specific model capabilities for the chatbot. | Forcing OpenAI Agents SDK would require re-evaluation of specific API capabilities and potentially increase development time for this feature, as well as divergence from the user's explicit intent. |