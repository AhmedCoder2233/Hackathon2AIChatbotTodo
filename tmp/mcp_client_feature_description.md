# SpecKit Input: Integrate MCP Server with OpenAI Agent ## Task MCP server already running at `http://localhost:8001/mcp/`. Need to integrate it with OpenAI Agents SDK in `support_agent.py` and connect from `main.py` with user_id from Better Auth. --- ## Part 1: Modify `backend/app/support_agent.py` ### Add MCP Client Setup Function **Imports:** ```python from agents import Agent from agents.mcp import MCPServerStreamableHttp, MCPServerStreamableHttpParams ``` **MCP Server URL:** ```python MCP_SERVER_URL = "http://localhost:8001/mcp/" ``` **Create Agent Function with user_id:** ```python async def create_todo_agent(user_id: str): """ Create an agent connected to the MCP todo server for a specific user. Args: user_id: The Better Auth user ID (from current_user.id) Returns: tuple: (agent, mcp_client) - Keep both to maintain connection """ # Configure MCP server parameters mcp_params = MCPServerStreamableHttpParams(url=MCP_SERVER_URL) # Create MCP client connection mcp_client = MCPServerStreamableHttp(params=mcp_params, name="TodoMCPServer") await mcp_client.__aenter__() # Initialize connection # Create agent with MCP tools agent = Agent( name="Todo Assistant", mcp_servers=[mcp_client], instructions=f""" You are a helpful Todo Management Assistant. You help users manage their tasks. **IMPORTANT: For ALL tool calls, you MUST pass user_id as: "{user_id}"** ## Available Tools: 1. add_task(user_id, title, description) - Create new task 2. list_tasks(user_id, status) - List tasks (status: "all", "pending", "completed") 3. complete_task(user_id, task_id) - Mark task complete 4. delete_task(user_id, task_id) - Delete task 5. update_task(user_id, task_id, title, description) - Update task ## Behavior Guidelines: ### Task Creation - User says: "add", "create", "remember", "I need to" - Action: add_task(user_id="{user_id}", title="...", description="...") - Response: "I've added '[task title]' to your todo list." ### Task Listing - User says: "show", "list", "what tasks" - Action: list_tasks(user_id="{user_id}", status="all") - Response: Format tasks clearly with IDs ### Task Completion - User says: "done", "complete", "finished" - Action: complete_task(user_id="{user_id}", task_id=X) - Response: "Great! Marked '[task title]' as completed." ### Task Deletion - User says: "delete", "remove" - Action: delete_task(user_id="{user_id}", task_id=X) - Response: "Removed '[task title]' from your list." ### Task Update - User says: "change", "update", "rename" - Action: update_task(user_id="{user_id}", task_id=X, title="...") - Response: "Updated '[task title]'." **CRITICAL: Always pass user_id="{user_id}" in every tool call for security.** """ ) return agent, mcp_client ``` **Keep existing support_agent for non-todo queries (if needed):** ```python # Existing support_agent can remain for other queries # support_agent = Agent(name="Support Agent", instructions="...") ``` --- ## Part 2: Modify `backend/app/main.py` ### Update the `respond` function in `CustomerSupportServer` class **Location:** Inside `class CustomerSupportServer`, `async def respond()` method **Changes needed:** 1. **Extract user_id from context:** ```python async def respond( self, thread: ThreadMetadata, input_user_message: UserMessageItem | None, context: dict[str, Any], ) -> AsyncIterator[ThreadStreamEvent]: # ... existing code for items_page, chat_history ... # GET USER ID FROM CONTEXT current_user = context.get("current_user") user_id = current_user.id # This is Better Auth user ID print(f"ðŸ†” User ID for MCP tools: {user_id}") ``` 2. **Import and create todo agent:** ```python # Import the function from app.support_agent import create_todo_agent # Create agent with user_id todo_agent, mcp_client = await create_todo_agent(user_id) print(f"âœ… Todo agent created for user: {user_id}") ``` 3. **Use todo agent instead of self.agent:** ```python # REPLACE this line: # result = Runner.run_streamed(self.agent, ...) # WITH this: result = Runner.run_streamed( todo_agent, # Use todo_agent instead of self.agent input_items, context=agent_context, run_config=RunConfig(model_settings=ModelSettings(temperature=0.4)), ) ``` 4. **Cleanup MCP client after streaming (optional but recommended):** ```python async for event in stream_agent_response(agent_context, result): yield event # Close MCP connection after response try: await mcp_client.__aexit__(None, None, None) except: pass ``` **Complete modified `respond` function structure:** ```python async def respond( self, thread: ThreadMetadata, input_user_message: UserMessageItem | None, context: dict[str, Any], ) -> AsyncIterator[ThreadStreamEvent]: # Existing code for loading items and history items_page = await self.store.load_thread_items(thread.id, None, 20, "desc", context) items = list(reversed(items_page.data)) chat_history = context.get("chat_history", []) # Convert history (existing code) history_items = [] if chat_history: # ... existing conversion logic ... pass if history_items: input_items = history_items else: converted_items = await self.thread_item_converter.to_agent_input(items) input_items = converted_items # NEW CODE STARTS HERE # Get user_id from context current_user = context.get("current_user") user_id = current_user.id print(f"ðŸ†” Creating todo agent for user: {user_id}") # Import and create todo agent from app.support_agent import create_todo_agent todo_agent, mcp_client = await create_todo_agent(user_id) # Create agent context agent_context = AgentContext( thread=thread, store=self.store, request_context=context, ) # Run agent with MCP tools result = Runner.run_streamed( todo_agent, # Use todo_agent with MCP connection input_items, context=agent_context, run_config=RunConfig(model_settings=ModelSettings(temperature=0.4)), ) # Stream response async for event in stream_agent_response(agent_context, result): yield event # Cleanup MCP connection try: await mcp_client.__aexit__(None, None, None) except: pass ``` --- ## Part 3: How It Works ### Flow: ``` 1. User sends message to /support/chatkit 2. main.py extracts current_user.id (Better Auth ID) 3. support_agent.py creates agent with user_id injected in instructions 4. Agent calls MCP tools at http://localhost:8001/mcp/ 5. MCP tools receive user_id and execute database operations 6. Response streams back to user ``` ### Security: - Every MCP tool call includes user_id - Database queries filter by user_id to prevent cross-user access - Agent instructions explicitly mention user_id for each tool call --- ## Testing **Start MCP Server:** ```bash cd backend/app python mcp_tools.py ``` **Start FastAPI:** ```bash uvicorn app.main:app --reload ``` **Test via ChatKit:** - "Add task to buy milk" â†’ Should call add_task with your user_id - "Show my tasks" â†’ Should call list_tasks with your user_id - "Mark task 1 as done" â†’ Should call complete_task with your user_id --- ## Summary - âœ… MCP server already running - âœ… Add `create_todo_agent(user_id)` function in `support_agent.py` - âœ… Modify `respond()` in `main.py` to use todo agent with user_id - âœ… Agent instructions include hardcoded user_id for all tool calls - âœ… Secure: Each user only accesses their own tasks